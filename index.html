<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Orion</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="app">
    <h1>Orion</h1>
    <p class="subtitle">Clareza antes da decisão.</p>

    <div class="controls">
      <button id="mic-btn">Falar com Orion</button>
      <button id="stop-btn">Parar</button>
    </div>

    <div id="status">Orion em repouso.</div>

    <div id="output"></div>

    <!-- INTERFACE DE TEMAS -->
    <div class="themes">
      <h2>Como o Orion pode te ajudar agora?</h2>

      <div class="theme-grid">
        <div class="theme-card" data-theme="emocional">Emoções</div>
        <div class="theme-card" data-theme="decisao">Decisão</div>
        <div class="theme-card" data-theme="financeiro">Financeiro</div>
        <div class="theme-card" data-theme="organizacao">Organização</div>
        <div class="theme-card" data-theme="reflexao">Reflexão</div>
      </div>
    </div>
  </div>

<script>
/* =========================
   ELEMENTOS
========================= */
const micBtn = document.getElementById("mic-btn");
const stopBtn = document.getElementById("stop-btn");
const statusEl = document.getElementById("status");
const output = document.getElementById("output");
const themeCards = document.querySelectorAll(".theme-card");

let isListening = false;
let isSpeaking = false;

/* =========================
   TEXT TO SPEECH
========================= */
function falar(texto) {
  if (!("speechSynthesis" in window)) return;

  speechSynthesis.cancel();
  isSpeaking = true;

  const utterance = new SpeechSynthesisUtterance(texto);
  utterance.lang = "pt-BR";

  utterance.onstart = () => {
    statusEl.innerText = "Orion está falando...";
  };

  utterance.onend = () => {
    isSpeaking = false;
    statusEl.innerText = "Orion aguardando você.";
  };

  speechSynthesis.speak(utterance);
}

stopBtn.onclick = () => {
  speechSynthesis.cancel();
  if (recognition) recognition.abort();
  isListening = false;
  isSpeaking = false;
  statusEl.innerText = "Interrompido.";
};

/* =========================
   MEMÓRIA LOCAL
========================= */
const memoriaKey = "orion_memoria";

function carregarMemoria() {
  return JSON.parse(localStorage.getItem(memoriaKey)) || {};
}

function salvarMemoria(memoria) {
  localStorage.setItem(memoriaKey, JSON.stringify(memoria));
}

/* =========================
   RESPOSTAS BASE (MVP)
========================= */
const respostas = {
  saudacao: [
    "Olá. Estou aqui.",
    "Pode falar."
  ],
  tristeza: [
    "O que aconteceu?",
    "Quer falar sobre isso?"
  ],
  ansiedade: [
    "Vamos desacelerar.",
    "O que está fora de controle?"
  ],
  raiva: [
    "O que te tirou do eixo?"
  ],
  medo: [
    "Do que você está se protegendo?"
  ],
  cansaco: [
    "Você precisa pausar."
  ],
  financeiro: [
    "Vamos organizar isso juntos."
  ],
  default: [
    "Entendo.",
    "Continue."
  ]
};

function detectarEstado(texto) {
  texto = texto.toLowerCase();
  if (/oi|olá|bom dia|boa noite/.test(texto)) return "saudacao";
  if (texto.includes("triste")) return "tristeza";
  if (texto.includes("ansioso")) return "ansiedade";
  if (texto.includes("raiva")) return "raiva";
  if (texto.includes("medo")) return "medo";
  if (texto.includes("cansado")) return "cansaco";
  if (texto.includes("dinheiro")) return "financeiro";
  return "default";
}

function gerarResposta(texto) {
  const estado = detectarEstado(texto);
  const memoria = carregarMemoria();

  memoria[estado] = (memoria[estado] || 0) + 1;
  salvarMemoria(memoria);

  const lista = respostas[estado];
  return lista[Math.min(memoria[estado] - 1, lista.length - 1)];
}

/* =========================
   SPEECH RECOGNITION
========================= */
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

let recognition = null;

if (!SpeechRecognition) {
  statusEl.innerText = "Reconhecimento de voz não suportado.";
} else {
  recognition = new SpeechRecognition();
  recognition.lang = "pt-BR";
  recognition.continuous = false;
  recognition.interimResults = false;

  micBtn.onclick = () => {
    if (isListening || isSpeaking) return;

    recognition.abort();
    recognition.start();

    isListening = true;
    statusEl.innerText = "Orion ouvindo...";
  };

  recognition.onresult = (event) => {
    const texto = event.results[0][0].transcript;

    output.innerHTML += `<strong>Você:</strong> ${texto}<br>`;

    const resposta = gerarResposta(texto);
    output.innerHTML += `<strong>Orion:</strong> ${resposta}<br><br>`;

    falar(resposta);
    isListening = false;
  };

  recognition.onerror = () => {
    statusEl.innerText = "Erro ao ouvir.";
    isListening = false;
  };

  recognition.onend = () => {
    isListening = false;
  };
}

/* =========================
   CLIQUE NOS TEMAS (PREPARADO)
========================= */
themeCards.forEach(card => {
  card.addEventListener("click", () => {
    const tema = card.dataset.theme;

    output.innerHTML += `<strong>Orion:</strong> Vamos falar sobre ${card.innerText.toLowerCase()}. Pode começar.<br><br>`;
    falar(`Vamos falar sobre ${card.innerText}. Pode começar.`);
  });
});
</script>

</body>
</html>
