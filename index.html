<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Orion</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <h1>Orion</h1>
    <p class="subtitle">Clareza antes da decisão.</p>

    <div class="controls">
      <button id="mic-btn">Falar com Orion</button>
      <button id="stop-btn">Parar</button>
    </div>

    <div id="status">Orion em repouso.</div>
    <div id="output"></div>
  </div>

  <script>
    // ==========================
    // ELEMENTOS
    // ==========================
    const micBtn = document.getElementById("mic-btn");
    const stopBtn = document.getElementById("stop-btn");
    const status = document.getElementById("status");
    const output = document.getElementById("output");

    let isListening = false;

    // ==========================
    // FALA (TTS)
    // ==========================
    function falar(texto) {
      if (!("speechSynthesis" in window)) return;

      speechSynthesis.cancel();

      const utterance = new SpeechSynthesisUtterance(texto);
      utterance.lang = "pt-BR";
      utterance.rate = 1;
      utterance.pitch = 1;
      utterance.volume = 1;

      utterance.onstart = () => {
        status.innerText = "Orion está falando...";
      };

      utterance.onend = () => {
        status.innerText = "Orion aguardando você.";
      };

      speechSynthesis.speak(utterance);
    }

    stopBtn.addEventListener("click", () => {
      speechSynthesis.cancel();
      status.innerText = "Orion interrompido.";
      isListening = false;
    });

    // ==========================
    // MEMÓRIA LOCAL
    // ==========================
    const memoriaKey = "orion_memoria";

    function carregarMemoria() {
      return JSON.parse(localStorage.getItem(memoriaKey)) || {};
    }

    function salvarMemoria(memoria) {
      localStorage.setItem(memoriaKey, JSON.stringify(memoria));
    }

    // ==========================
    // RESPOSTAS
    // ==========================
    const respostas = {
      saudacao: [
        "Olá. Estou aqui com você.",
        "Pode falar, estou ouvindo."
      ],
      tristeza: [
        "Percebo tristeza. O que aconteceu?",
        "Quer me contar o que está pesando hoje?"
      ],
      ansiedade: [
        "Vamos com calma. O que está te acelerando?",
        "Respire. O que está fora de controle agora?"
      ],
      raiva: [
        "A raiva costuma esconder algo mais profundo.",
        "O que te tirou do eixo?"
      ],
      medo: [
        "O medo mostra que isso importa.",
        "Do que você está tentando se proteger?"
      ],
      cansaço: [
        "Seu corpo e mente pedem pausa.",
        "O que mais te drena energia?"
      ],
      financeiro: [
        "Dinheiro gera pressão real.",
        "Quer organizar isso juntos?"
      ],
      default: [
        "Entendo. Continue.",
        "Pode falar mais sobre isso."
      ]
    };

    function detectarEstado(texto) {
      texto = texto.toLowerCase();
      if (texto.match(/oi|olá|bom dia|boa noite/)) return "saudacao";
      if (texto.includes("triste")) return "tristeza";
      if (texto.includes("ansioso")) return "ansiedade";
      if (texto.includes("raiva") || texto.includes("irritado")) return "raiva";
      if (texto.includes("medo")) return "medo";
      if (texto.includes("cansado")) return "cansaço";
      if (texto.includes("dinheiro") || texto.includes("financeiro")) return "financeiro";
      return "default";
    }

    function gerarResposta(textoUsuario) {
      const estado = detectarEstado(textoUsuario);
      const memoria = carregarMemoria();

      memoria[estado] = (memoria[estado] || 0) + 1;
      salvarMemoria(memoria);

      const lista = respostas[estado];
      const index = Math.min(memoria[estado] - 1, lista.length - 1);
      return lista[index];
    }

    // ==========================
    // RECONHECIMENTO DE VOZ
    // ==========================
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
      status.innerText = "Reconhecimento de voz não suportado.";
    } else {
      const recognition = new SpeechRecognition();
      recognition.lang = "pt-BR";
      recognition.continuous = false;
      recognition.interimResults = false;

      micBtn.addEventListener("click", () => {
        if (isListening) return;

        speechSynthesis.cancel();
        recognition.start();
        isListening = true;
        status.innerText = "Orion ouvindo...";
      });

      recognition.onresult = (event) => {
        const texto = event.results[0][0].transcript;

        output.innerHTML += `<strong>Você:</strong> ${texto}<br>`;

        const resposta = gerarResposta(texto);
        output.innerHTML += `<strong>Orion:</strong> ${resposta}<br><br>`;

        falar(resposta);
        isListening = false;
      };

      recognition.onerror = () => {
        status.innerText = "Erro ao ouvir. Tente novamente.";
        isListening = false;
      };

      recognition.onend = () => {
        isListening = false;
      };
    }
  </script>
</body>
</html>
